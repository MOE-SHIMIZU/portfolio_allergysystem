<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{system/parts/common :: html_head()}"></head>

<body>

	<form action="" method="post" enctype="multipart/form-data" th:object="${order}" id="form">
		<!-- SP版ハンバーガーメニュー -->
		<th:block th:replace="~{system/parts/common :: hamburgerMenu()}"></th:block>

		<div class="container-fluid">
			<!-- サイドメニュー（PC版） -->
			<div class="row">
				<nav th:replace="~{system/parts/common :: sideMenu()}" id="sidebar"
					class="col-lg-3 position-fixed d-none d-lg-block"></nav>

				<div class="container-fluid">
					<div class="row">

						<!-- メインコンテンツ -->
						<main class="col-lg-9 p-lg-5 offset-lg-3">
							<div class="container">

								<h1 class="">商品新規登録</h1>

								<!-- エラーメッセージを表示 -->
								<div th:if="${errorMessage}" class="mt-4">[[${errorMessage}]]</div>

								<div class="table-responsive mt-4">
									<table class="table table-striped table-hover addOrderTable">

										<tr>
											<th>商品名：</th>
											<td><input type="text" th:field="*{name}" class="form-control"> <small
													class="error-message" th:errors="*{name}"></small></td>
										</tr>
										<tr>
											<th>商品名カナ：</th>
											<td><input type="text" th:field="*{kana}" class="form-control"> <small
													class="error-message" th:errors="*{kana}"></small></td>
										</tr>
										<tr>
											<th>価格(税抜)：</th>
											<td><input type="text" th:field="*{price}" class="form-control"> <small
													class="error-message" th:errors="*{price}"></small></td>
										</tr>
										<tr>
											<th>商品画像：</th>
											<td><input type="file" th:field="*{upfile}" accept="image/png, image/jpeg"
													class="form-control">
												<small class="error-message" th:errors="*{upfile}"></small>
											</td>
										</tr>
										<tr>
											<th>備考：</th>
											<td><textarea th:field="*{note}" cols="40" rows="3"
													class="form-control"></textarea></td>
										</tr>

									</table>

									<table class="table table-striped table-hover addOrderTableBelow mt-4">
										<thead class="">
											<tr>
												<th colspan="1">#</th>
												<th colspan="2">使用食材</th>
												<th colspan="1">操作</th>
											</tr>
										</thead>
										<tbody class="table-group-divider">

											<th:block th:each="detail, st : *{ingredientIdList}">
												<tr class="inputFields">
													<th class="num"></th>
													<td>食品カテゴリー： <select class="form-control first" name="cat[]">
															<option value="">select</option>
															<th:block th:each="foodCat : ${foodCatList}">
																<option th:value="${foodCat.id}"
																	th:text="${foodCat.name}">
																</option>
															</th:block>
														</select>
													</td>

													<td>食材： <select th:field="*{ingredientIdList[__${st.index}__].id}"
															class="form-control second allergyRow" name='ingredientsId[]'>
															<option value="">select</option>
															<th:block th:each="ingredient : ${ingredients}">
																<option th:value="${ingredient.id}"
																	th:data-cat="${ingredient.foodCatId}"
																	th:text="${ingredient.name}"></option>
															</th:block>
														</select>
													</td>

													<td>
														<button type="button" class="btn-remove">dele</button>
													</td>
												</tr>

											</th:block>

											<tr>
												<td></td>
												<td colspan="2"></td>
												<td>
													<button type="button" class="btn-clone">plus</button>
												</td>
											</tr>


										</tbody>
									</table>

									<div class="text-center my-5">
										<input type="submit" value="保存" class="btn-save">
									</div>

								</div>

							</div>
						</main>

					</div>
				</div>
			</div>

		</div>
	</form>

	<!-- 右側から表示されるOffcanvasメニュー -->
	<div th:replace="~{system/parts/common :: offcanvasMenu()}"></div>
	<th:block th:replace="~{system/parts/common :: javascripts()}"></th:block>

	<script>
		$(function () {
			const btn_clone = $(".btn-clone");

			btn_clone.click(function () {
				const lastRowIndex = $(".inputFields").length - 1;
				const clonedFields = $(".inputFields").eq(lastRowIndex).clone();

				clonedFields.find(".allergyRow").each(
					function (index) {
						const name = $(this).attr("name");

						const updatedName = name.replace(/\[(\d+)\]/g,
							function (match, p1) {
								const index = parseInt(p1) + lastRowIndex + 1;
								return `[${index}]`;
							});

						$(this).attr("name", updatedName);
						$(this).val("");
					});

				clonedFields.find(".btn-remove").show();
				clonedFields.find('select').val('');
				$(this).closest(".btn-clone").closest("tr").before(clonedFields);
			});

			$(document).on("click", ".btn-remove", function () {
				const row = $(this).closest("tr");
				if (row.siblings().length > 1) {
					row.remove();
				} else {
					alert("最後の行は削除できません。");
				}
			});

		});
	</script>

	<!-- ２つのselectテーブルの連携:start -->
	<script th:inline="javascript">
		$(document)
			.ready(
				function () {
					const ingredients = /*[[${ingredients}]]*/"ingredients";

					$('.first')
						.click(
							function () {

								var firstSelect = this;

								var secondSelect = this.parentNode.parentNode
									.querySelector('.second')

								var selectedCategoryId = this.value;

								while (secondSelect.firstChild) {

									secondSelect
										.removeChild(secondSelect.firstChild);

								}

								ingredients
									.forEach(function (
										ingredient) {

										if (ingredient.foodCatId == selectedCategoryId) {

											var option = document
												.createElement('option');

											option.value = ingredient.id;

											option.text = ingredient.name;

											secondSelect
												.appendChild(option);

										}

									});

							});

				});
	</script>
	<!-- ２つのselectテーブルの連携:end -->

</body>

</html>